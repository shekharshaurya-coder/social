<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - SocialSync</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .profile-header {
            background: #18191a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #2f3336;
        }

        .profile-top {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 700;
            color: #e4e6eb;
            margin-bottom: 5px;
        }

        .profile-username {
            font-size: 16px;
            color: #8b8d91;
            margin-bottom: 15px;
        }

        .profile-stats {
            display: flex;
            gap: 30px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .stat-item:hover {
            opacity: 0.7;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #e4e6eb;
        }

        .stat-label {
            font-size: 14px;
            color: #8b8d91;
            margin-top: 2px;
        }

        .profile-bio {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2f3336;
        }

        .bio-label {
            font-size: 14px;
            color: #8b8d91;
            margin-bottom: 8px;
        }

        .bio-text {
            font-size: 16px;
            color: #e4e6eb;
            line-height: 1.5;
        }

        .bio-empty {
            font-style: italic;
            color: #666;
        }

        .edit-profile-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
        }

        .edit-profile-btn:hover {
            background: #764ba2;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #2f3336;
            color: #e4e6eb;
            border: 1px solid #3a3b3c;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            transition: 0.3s;
        }

        .back-btn:hover {
            background: #3a3b3c;
        }

        .edit-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal-overlay.active {
            display: flex;
        }

        .edit-modal {
            background: #242526;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .edit-modal-header {
            padding: 20px;
            border-bottom: 1px solid #3a3b3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #e4e6eb;
        }

        .edit-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #8b8d91;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.3s;
        }

        .edit-modal-close:hover {
            background: #3a3b3c;
            color: #e4e6eb;
        }

        .edit-modal-body {
            padding: 20px;
        }

        .edit-form-group {
            margin-bottom: 20px;
        }

        .edit-form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #e4e6eb;
        }

        .edit-form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #3a3b3c;
            border-radius: 8px;
            background: #18191a;
            color: #e4e6eb;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .edit-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .edit-form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #3a3b3c;
            border-radius: 8px;
            background: #18191a;
            color: #e4e6eb;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
        }

        .edit-form-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .edit-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #3a3b3c;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .edit-btn-cancel {
            padding: 10px 20px;
            border: 1px solid #3a3b3c;
            background: #18191a;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #e4e6eb;
            transition: 0.3s;
        }

        .edit-btn-cancel:hover {
            background: #2f3336;
        }

        .edit-btn-save {
            padding: 10px 30px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: 0.3s;
        }

        .edit-btn-save:hover {
            background: #764ba2;
        }

        .edit-btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: #ff7979;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #7bed9f;
            font-size: 13px;
            margin-top: 10px;
            display: none;
        }

        .preview-avatar-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .preview-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            overflow: hidden;
        }

        .preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .upload-btn:hover {
            background: #764ba2;
        }

        .helper-text {
            font-size: 12px;
            color: #8b8d91;
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <a href="/index.html" class="back-btn">‚Üê Back to Feed</a>

        <div class="profile-header">
            <div class="profile-top">
                <div class="profile-avatar-large" id="profileAvatar">
                    üë§
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-username" id="profileUsername">@username</div>
                    <div class="profile-stats">
                        <div class="stat-item" id="followersBtn">
                            
                            <div class="stat-number" id="followersCount">0</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-item" id="followingBtn">
                            <div class="stat-number" id="followingCount">0</div>
                            <div class="stat-label">Following</div>
                            

                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="postsCount">0</div>
                            <div class="stat-label">Posts</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-bio">
                <div class="bio-label">Bio</div>
                <div class="bio-text" id="profileBio">
                    <span class="bio-empty">No bio yet</span>
                </div>
            </div>

            <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
        </div>

        <!-- Posts Grid Section -->
        <div class="posts-section" style="margin-top: 40px;">
            <div style="font-size: 18px; font-weight: 600; color: #e4e6eb; margin-bottom: 20px;">Posts</div>
            <div id="userPostsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                <div style="padding: 20px; text-align: center; color: #8b8d91; grid-column: 1 / -1;">Loading posts...</div>
            </div>
        </div>
    </div>

    <!-- Post Modal (for viewing full post) -->
    <div id="postModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:#242526; border-radius:12px; max-width:600px; width:90%; max-height:80vh; overflow:auto; position:relative;">
            <button onclick="closePostModal()" style="position:absolute; top:10px; right:10px; background:none; border:none; color:#e4e6eb; font-size:28px; cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center;">√ó</button>
            <div id="postModalContent" style="padding:20px;"></div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="edit-modal-overlay" id="editModal">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <div class="edit-modal-title">Edit Profile</div>
                <button class="edit-modal-close" id="closeModalBtn">√ó</button>
            </div>

            <div class="edit-modal-body">
                <div class="edit-form-group">
                    <label class="edit-form-label">Display Name</label>
                    <input type="text" id="editDisplayName" class="edit-form-input" placeholder="Your display name">
                </div>
                
                <div class="edit-form-group">
                    <label class="edit-form-label">Username</label>
                    <input type="text" id="editUsername" class="edit-form-input" placeholder="username">
                </div>

                <div class="edit-form-group">
                    <label class="edit-form-label">Profile Picture</label>
                    <div class="preview-avatar-container">
                        <div class="preview-avatar" id="previewAvatar">
                            üë§
                        </div>
                        <div style="flex:1;">
                            <input type="file" id="avatarFileInput" accept="image/*" style="display:none;">
                            <button class="upload-btn" id="uploadBtn">Choose Image</button>
                            <div class="helper-text">Or enter URL below</div>
                        </div>
                    </div>
                    <input type="url" id="editAvatarUrl" class="edit-form-input" placeholder="https://example.com/avatar.jpg">
                </div>

                <div class="edit-form-group">
                    <label class="edit-form-label">Bio</label>
                    <textarea id="editBio" class="edit-form-textarea" placeholder="Tell us about yourself..."></textarea>
                </div>

                <div class="error-message" id="editError"></div>
                <div class="success-message" id="editSuccess"></div>
            </div>

            <div class="edit-modal-footer">
                <button class="edit-btn-cancel" id="cancelBtn">Cancel</button>
                <button class="edit-btn-save" id="saveBtn">Save Changes</button>
            </div>
        </div>
    </div>
<div id="followersContainer" style="display:none; position:absolute; z-index:9999;"></div>
<div id="followingContainer" style="display:none; position:absolute; z-index:9999;"></div>

    <script>
        const API_URL = 'http://localhost:3000';
        const token = sessionStorage.getItem('token');

        if (!token) {
            window.location.href = '/login.html';
        }

        let currentUser = null;
        let selectedImageFile = null;

        // Fetch API helper
        async function fetchAPI(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            try {
                console.log(`Fetching: ${endpoint}`);
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...defaultOptions,
                    ...options,
                    headers: { ...defaultOptions.headers, ...options.headers }
                });

                if (response.status === 401) {
                    sessionStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }

                const data = await response.json();
                console.log(`Response from ${endpoint}:`, data);
                return data;
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                throw error;
            }
        }

        // Load user profile data
        async function loadProfile() {
            try {
                console.log('Loading profile...');
                const user = await fetchAPI('/api/users/me');
                console.log('User data received:', user);
                
                currentUser = user;

                // Update profile display
                document.getElementById('profileName').textContent = user.displayName || user.username;
                document.getElementById('profileUsername').textContent = `@${user.username}`;
                document.getElementById('followersCount').textContent = user.followersCount || 0;
                document.getElementById('followingCount').textContent = user.followingCount || 0;

                // Update bio
                const bioElement = document.getElementById('profileBio');
                if (user.bio && user.bio.trim() !== '') {
                    bioElement.innerHTML = `<span>${user.bio}</span>`;
                } else {
                    bioElement.innerHTML = '<span class="bio-empty">No bio yet</span>';
                }

                // Update avatar
                const avatarElement = document.getElementById('profileAvatar');
                if (user.avatarUrl && user.avatarUrl.trim() !== '') {
                    avatarElement.innerHTML = `<img src="${user.avatarUrl}" alt="Avatar">`;
                } else {
                    avatarElement.innerHTML = 'üë§';
                }

                // Load posts count
                document.getElementById('postsCount').textContent = '0';

                console.log('Profile loaded successfully');
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile. Please refresh the page.');
            }
        }

        // Show edit modal
        function showEditModal() {
            if (!currentUser) {
                console.error('Current user not loaded');
                return;
            }

            console.log('Opening edit modal with user:', currentUser);

            document.getElementById('editDisplayName').value = currentUser.displayName || '';
            document.getElementById('editUsername').value = currentUser.username || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            document.getElementById('editAvatarUrl').value = currentUser.avatarUrl || '';

            // Update preview
            const previewAvatar = document.getElementById('previewAvatar');
            if (currentUser.avatarUrl && currentUser.avatarUrl.trim() !== '') {
                previewAvatar.innerHTML = `<img src="${currentUser.avatarUrl}" alt="Preview">`;
            } else {
                previewAvatar.innerHTML = 'üë§';
            }

            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editError').style.display = 'none';
            document.getElementById('editSuccess').style.display = 'none';
            selectedImageFile = null;
        }

        // Preview profile picture from file
        function previewProfilePic(event) {
            const file = event.target.files[0];
            if (file) {
                selectedImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewAvatar').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    document.getElementById('editAvatarUrl').value = '';
                };
                reader.readAsDataURL(file);
            }
        }

        // Update preview from URL
        function updatePreview() {
            const url = document.getElementById('editAvatarUrl').value.trim();
            if (url) {
                selectedImageFile = null;
                document.getElementById('previewAvatar').innerHTML = `<img src="${url}" alt="Preview" onerror="this.parentElement.innerHTML='üë§'">`;
            }
        }

        // Save profile changes
        async function saveProfile() {
            const displayName = document.getElementById('editDisplayName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            let avatarUrl = document.getElementById('editAvatarUrl').value.trim();

            const errorEl = document.getElementById('editError');
            const successEl = document.getElementById('editSuccess');
            const saveBtn = document.getElementById('saveBtn');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            // Validation
            if (!username) {
                errorEl.textContent = 'Username is required';
                errorEl.style.display = 'block';
                return;
            }

            if (username.length < 3) {
                errorEl.textContent = 'Username must be at least 3 characters';
                errorEl.style.display = 'block';
                return;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorEl.textContent = 'Username can only contain letters, numbers and underscores';
                errorEl.style.display = 'block';
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                // If user selected a file, convert to base64
                if (selectedImageFile) {
                    avatarUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(selectedImageFile);
                    });
                }

                const updates = {
                    displayName,
                    username,
                    bio,
                    avatarUrl
                };

                console.log('Saving profile updates:', updates);

                const updatedUser = await fetchAPI('/api/users/me', {
                    method: 'PUT',
                    body: JSON.stringify(updates)
                });

                console.log('Profile updated:', updatedUser);

                currentUser = updatedUser;
                selectedImageFile = null;

                successEl.textContent = 'Profile updated successfully!';
                successEl.style.display = 'block';

                await loadProfile();

                setTimeout(() => {
                    closeEditModal();
                }, 1500);

            } catch (error) {
                console.error('Error saving profile:', error);
                errorEl.textContent = error.message || 'Failed to update profile. Please try again.';
                errorEl.style.display = 'block';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        // Show followers list
/* fallback placeholder (you uploaded this file) */
const PLACEHOLDER = 'monkey.jpg';

/* small helper to render an array of users into a container element */
function renderDropdown(containerId, users, anchorEl) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.style.display = 'block';
  container.style.width = '320px';
  container.style.background = '#111';
  container.style.border = '1px solid rgba(255,255,255,0.06)';
  container.style.borderRadius = '10px';
  container.style.padding = '10px';
  container.innerHTML = users.map(user => {
    const avatar = user.avatarUrl || PLACEHOLDER;
    const count = user.followerCount ?? 0;
    return `
      <div style="display:flex;gap:12px;padding:12px;border-radius:8px;align-items:center;">
        <img src="${avatar}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;" onerror="this.src='${PLACEHOLDER}'" />
        <div style="flex:1;">
          <div style="font-weight:600;color:#e4e6eb">${escapeHtml(user.name || user.username)}</div>
          <div style="color:#8b8d91">@${escapeHtml(user.username)}</div>
          <div style="color:#666;font-size:12px">${count} follower${count===1?'':'s'}</div>
        </div>
      </div>
    `;
  }).join('');

  // position under anchor
  if (anchorEl) {
    const rect = anchorEl.getBoundingClientRect();
    container.style.left = (rect.left) + 'px';
    container.style.top = (rect.bottom + 8) + 'px';
  }
}

/* helper escape to avoid injection */
function escapeHtml(s='') {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* show followers/following using your endpoints */
async function showFollowers() {
  const userId = currentUser.id; // your existing variable
  const anchor = document.getElementById('followersBtn');
  try {
    const res = await fetch(`/api/users/${userId}/followers`);
    const data = await res.json();
    if (!Array.isArray(data)) return renderDropdown('followersContainer', [], anchor);
    renderDropdown('followersContainer', data, anchor);
  } catch (err) {
    console.error(err);
    renderDropdown('followersContainer', [], anchor);
  }
}

async function showFollowing() {
  const userId = currentUser.id;
  const anchor = document.getElementById('followingBtn');
  try {
    const res = await fetch(`/api/users/${userId}/following-list`);
    const data = await res.json();
    if (!Array.isArray(data)) return renderDropdown('followingContainer', [], anchor);
    renderDropdown('followingContainer', data, anchor);
  } catch (err) {
    console.error(err);
    renderDropdown('followingContainer', [], anchor);
  }
}

/* close dropdown on outside click */
window.addEventListener('click', (e) => {
  if (!e.target.closest('#followersContainer') && !e.target.closest('#followersBtn')) {
    document.getElementById('followersContainer').style.display = 'none';
  }
  if (!e.target.closest('#followingContainer') && !e.target.closest('#followingBtn')) {
    document.getElementById('followingContainer').style.display = 'none';
  }
});
        // Display user list modal
        function displayUserList(users, title) {
            const modalHTML = `
                <div class="modal-overlay active" id="userListModal" style="z-index:2000;">
                    <div class="modal" style="background:#242526;border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow:hidden;">
                        <div style="padding:20px;border-bottom:1px solid #3a3b3c;display:flex;justify-content:space-between;align-items:center;">
                            <div style="font-size:18px;font-weight:600;color:#e4e6eb;">${title}</div>
                            <button onclick="closeUserListModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#8b8d91;padding:0;width:30px;height:30px;">√ó</button>
                        </div>
                        <div style="padding:20px;max-height:400px;overflow-y:auto;">
                            ${users.length === 0 ? `<div style="text-align:center;color:#8b8d91;">No ${title.toLowerCase()} yet</div>` : ''}
                            ${users.map(user => `
                                <div style="display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;background:#18191a;margin-bottom:8px;">
                                    <div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden;">
                                        ${user.avatarUrl ? `<img src="${user.avatarUrl}|| style="width:100%;height:100%;object-fit:cover;">` : 'üë§'}
                                    </div>
                                    <div style="flex:1;">
                                        <div style="font-weight:600;font-size:14px;color:#e4e6eb;">${user.displayName || user.username}</div>
                                        <div style="font-size:13px;color:#8b8d91;">@${user.username}</div>
                                        <div style="font-size:12px;color:#666;">${user.followersCount} followers</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('userListModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Close user list modal
        function closeUserListModal() {
            const modal = document.getElementById('userListModal');
            if (modal) modal.remove();
        }

        // Event Listeners
        document.getElementById('editProfileBtn').addEventListener('click', showEditModal);
        document.getElementById('closeModalBtn').addEventListener('click', closeEditModal);
        document.getElementById('cancelBtn').addEventListener('click', closeEditModal);
        document.getElementById('saveBtn').addEventListener('click', saveProfile);
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('avatarFileInput').click();
        });
        document.getElementById('avatarFileInput').addEventListener('change', previewProfilePic);
        document.getElementById('editAvatarUrl').addEventListener('input', updatePreview);
        //document.getElementById('followersBtn').addEventListener('click', showFollowers);
        //document.getElementById('followingBtn').addEventListener('click', showFollowing);

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Load user posts
        async function loadUserPosts() {
            try {
                if (!currentUser || !currentUser.id) {
                    console.error('Current user not loaded yet');
                    return;
                }

                console.log('Loading posts for user:', currentUser.id);
                const response = await fetchAPI(`/api/users/${currentUser.id}/posts`);
                
                const posts = response.posts || [];
                const postsGrid = document.getElementById('userPostsGrid');

                if (posts.length === 0) {
                    postsGrid.innerHTML = '<div style="padding:20px; text-align:center; color:#8b8d91; grid-column:1/-1;">No posts yet</div>';
                    document.getElementById('postsCount').textContent = '0';
                    return;
                }

                // Update posts count
                document.getElementById('postsCount').textContent = posts.length;

                // Create grid items for posts
                const postsHTML = posts.map(post => {
                    const thumbnailUrl = post.mediaUrl || post.thumbnail;
                    const hasMedia = !!thumbnailUrl;

                    return `
                        <div class="post-grid-item" onclick="openPostModal('${post.id}', '${post.username}', '${post.displayName}', '${post.avatar}', '${post.content.replace(/'/g, "\\'")}', '${thumbnailUrl || ''}', ${post.likes}, ${post.comments})" style="
                            position: relative;
                            cursor: pointer;
                            border-radius: 8px;
                            overflow: hidden;
                            background: #18191a;
                            aspect-ratio: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: 0.3s;
                        ">
                            ${hasMedia ? `<img src="${thumbnailUrl}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none';" alt="Post">` : ''}
                            <div style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: ${hasMedia ? 'rgba(0,0,0,0.3)' : 'rgba(102,126,234,0.1)'};
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                opacity: 0;
                                transition: 0.3s;
                            " class="post-overlay">
                                <div style="text-align:center;">
                                    <div style="color:#fff; font-size:14px; font-weight:600; margin-bottom:5px;">‚ù§Ô∏è ${post.likes}</div>
                                    <div style="color:#fff; font-size:12px;">üí¨ ${post.comments}</div>
                                </div>
                            </div>
                            ${!hasMedia ? `<div style="padding:10px; text-align:center; color:#e4e6eb; font-size:14px; word-break:break-word;">${post.content.substring(0, 80)}${post.content.length > 80 ? '...' : ''}</div>` : ''}
                        </div>
                    `;
                }).join('');

                postsGrid.innerHTML = postsHTML;

                // Add hover effect
                document.querySelectorAll('.post-grid-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.querySelector('.post-overlay').style.opacity = '1';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.querySelector('.post-overlay').style.opacity = '0';
                    });
                });

                console.log('‚úÖ Posts loaded:', posts.length);
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('userPostsGrid').innerHTML = '<div style="padding:20px; text-align:center; color:#ff7979; grid-column:1/-1;">Failed to load posts</div>';
            }
        }

        // Open post detail modal
        function openPostModal(postId, username, displayName, avatar, content, mediaUrl, likes, comments) {
            const modal = document.getElementById('postModal');
            const modalContent = document.getElementById('postModalContent');

            modalContent.innerHTML = `
                <div style="padding:20px;">
                    <div style="display:flex; gap:15px; margin-bottom:20px;">
                        <div style="width:50px; height:50px; border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); display:flex; align-items:center; justify-content:center; font-size:24px; overflow:hidden; flex-shrink:0;">
                            ${avatar && avatar !== 'üë§' ? `<img src="${avatar}" style="width:100%; height:100%; object-fit:cover;">` : 'üë§'}
                        </div>
                        <div>
                            <div style="font-weight:600; color:#e4e6eb;">${displayName}</div>
                            <div style="color:#8b8d91; font-size:13px;">@${username}</div>
                        </div>
                    </div>

                    ${mediaUrl ? `
                        <div style="margin:20px 0; border-radius:8px; overflow:hidden; background:#18191a; max-height:400px;">
                            <img src="${mediaUrl}" style="width:100%; height:auto; max-height:400px; object-fit:cover;" onerror="this.alt='Image unavailable';" alt="Post media">
                        </div>
                    ` : ''}

                    <div style="color:#e4e6eb; margin:15px 0; font-size:15px; word-break:break-word;">${content}</div>

                    <div style="display:flex; gap:20px; margin-top:20px; padding-top:20px; border-top:1px solid #3a3b3c;">
                        <div style="text-align:center;">
                            <div style="color:#e4e6eb; font-weight:600;">${likes}</div>
                            <div style="color:#8b8d91; font-size:12px;">Likes</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="color:#e4e6eb; font-weight:600;">${comments}</div>
                            <div style="color:#8b8d91; font-size:12px;">Comments</div>
                        </div>
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Close post modal
        function closePostModal() {
            document.getElementById('postModal').style.display = 'none';
        }

        // Close modal on outside click
        document.getElementById('postModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePostModal();
            }
        });

        // Load profile on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing...');
            loadProfile();
            // Load posts after a short delay to ensure currentUser is set
            setTimeout(() => {
                loadUserPosts();
            }, 500);
        });

        
/**
 * Render a list of user objects into a container.
 * Expects each user to have: { id, username, name, avatarUrl, followerCount }
 */
function displayUserList(containerSelector, users) {
  const container = document.querySelector(containerSelector);
  if (!container) return console.warn('no container', containerSelector);

  if (!Array.isArray(users)) {
    console.error('displayUserList expected array, got:', users);
    container.innerHTML = '<div style="color:#aaa;padding:12px;">No users to display</div>';
    return;
  }

  container.innerHTML = users.map(user => {
    const count = user.followerCount ?? 0;
    return `
      <div style="display:flex;gap:12px;padding:14px;border-radius:10px;background:#111;margin-bottom:10px;align-items:center;">
        <img src="${user.avatarUrl || "monkey.jpg"}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;" />
        <div style="flex:1;">
          <div style="font-weight:600;font-size:14px;color:#e4e6eb;">${escapeHtml(user.name || user.username)}</div>
          <div style="font-size:13px;color:#8b8d91;">@${escapeHtml(user.username)}</div>
          <div style="font-size:12px;color:#666;">${count} follower${count === 1 ? '' : 's'}</div>
        </div>
      </div>
    `;
  }).join('');
}


function escapeHtml(str = '') {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}
document.querySelectorAll('img').forEach(img => {
  try { img.onerror = null; img.src = '/monkey.jpg'; } catch(e) {}
});
// FOLLOWERS HOVER
const followersBtn = document.getElementById('followersBtn');
const followersBox = document.getElementById('followersContainer');

followersBtn.addEventListener('mouseenter', () => {
  showFollowers(); // fetch & display
  followersBox.style.display = 'block';
});

followersBtn.addEventListener('mouseleave', () => {
  setTimeout(() => {
    if (!followersBox.matches(':hover')) {
      followersBox.style.display = 'none';
    }
  }, 150);
});

followersBox.addEventListener('mouseleave', () => {
  followersBox.style.display = 'none';
});


// FOLLOWING HOVER
const followingBtn = document.getElementById('followingBtn');
const followingBox = document.getElementById('followingContainer');

followingBtn.addEventListener('mouseenter', () => {
  showFollowing(); // fetch & display
  followingBox.style.display = 'block';
});

followingBtn.addEventListener('mouseleave', () => {
  setTimeout(() => {
    if (!followingBox.matches(':hover')) {
      followingBox.style.display = 'none';
    }
  }, 150);
});

followingBox.addEventListener('mouseleave', () => {
  followingBox.style.display = 'none';
});
//messges done 

        
    </script>
</body>
</html>